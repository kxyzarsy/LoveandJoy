{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///D:/MyBlog/LoveandJoy/src/app/api/dashboard-stats/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport mysql from 'mysql2/promise';\r\nimport jwt from 'jsonwebtoken';\r\n\r\n// 创建数据库连接\r\nasync function createConnection() {\r\n  return mysql.createConnection({\r\n    host: 'localhost',\r\n    port: 3306,\r\n    user: 'root',\r\n    password: '123456',\r\n    database: 'yueblog'\r\n  });\r\n}\r\n\r\n// 验证JWT令牌\r\nasync function verifyToken(request: Request) {\r\n  // 从请求头获取Authorization令牌\r\n  const authHeader = request.headers.get('Authorization');\r\n  const token = authHeader?.replace('Bearer ', '');\r\n  \r\n  // 没有令牌，返回401错误\r\n  if (!token) {\r\n    return { valid: false, error: '未授权访问', status: 401 };\r\n  }\r\n  \r\n  try {\r\n    // 验证JWT令牌\r\n    const secretKey = process.env.JWT_SECRET || 'your-secret-key';\r\n    const decoded = jwt.verify(token, secretKey) as {\r\n      userId: number;\r\n      email: string;\r\n      role: string;\r\n    };\r\n    \r\n    // 检查用户是否为管理员\r\n    if (decoded.role !== 'admin') {\r\n      return { valid: false, error: '权限不足', status: 403 };\r\n    }\r\n    \r\n    return { valid: true, decoded };\r\n  } catch (error) {\r\n    console.error('JWT验证失败:', error);\r\n    return { valid: false, error: '无效的令牌', status: 401 };\r\n  }\r\n}\r\n\r\n// 缓存数据和过期时间\r\nlet cachedStats: any = null;\r\nlet cacheExpiry: number = 0;\r\nconst CACHE_DURATION = 60 * 1000; // 1分钟缓存\r\n\r\n// 获取仪表盘统计数据\r\nexport async function GET(request: Request) {\r\n  // 验证令牌\r\n  const tokenVerification = await verifyToken(request);\r\n  if (!tokenVerification.valid) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: tokenVerification.error\r\n    }, { status: tokenVerification.status });\r\n  }\r\n\r\n  try {\r\n    // 检查缓存是否有效\r\n    const now = Date.now();\r\n    if (cachedStats && now < cacheExpiry) {\r\n      return NextResponse.json(cachedStats, { status: 200 });\r\n    }\r\n\r\n    // 连接数据库\r\n    const connection = await createConnection();\r\n    \r\n    // 查询各表统计数据\r\n    const [postsResult] = await connection.execute('SELECT COUNT(*) as count FROM post');\r\n    const [usersResult] = await connection.execute('SELECT COUNT(*) as count FROM user');\r\n    const [commentsResult] = await connection.execute('SELECT COUNT(*) as count FROM comment');\r\n    const [categoriesResult] = await connection.execute('SELECT COUNT(*) as count FROM category');\r\n    \r\n    await connection.end();\r\n    \r\n    // 解析查询结果\r\n    const totalPosts = (postsResult as any[])[0].count;\r\n    const totalUsers = (usersResult as any[])[0].count;\r\n    const totalComments = (commentsResult as any[])[0].count;\r\n    const totalCategories = (categoriesResult as any[])[0].count;\r\n    \r\n    // 构建统计数据\r\n    const stats = {\r\n      totalPosts,\r\n      totalUsers,\r\n      totalComments,\r\n      totalCategories,\r\n      lastUpdated: new Date().toISOString(),\r\n      dataSource: 'database' // 明确标记数据来源为数据库\r\n    };\r\n\r\n    // 更新缓存\r\n    cachedStats = stats;\r\n    cacheExpiry = now + CACHE_DURATION;\r\n\r\n    return NextResponse.json(stats, { status: 200 });\r\n  } catch (error) {\r\n    console.error('获取仪表盘统计数据失败:', error);\r\n    \r\n    // 返回模拟数据作为最后的后备\r\n    const fallbackStats = {\r\n      totalPosts: 0,\r\n      totalUsers: 0,\r\n      totalComments: 0,\r\n      totalCategories: 0,\r\n      lastUpdated: new Date().toISOString(),\r\n      dataSource: 'fallback'\r\n    };\r\n    \r\n    return NextResponse.json(fallbackStats, { status: 200 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,UAAU;AACV,eAAe;IACb,OAAO,8IAAK,CAAC,gBAAgB,CAAC;QAC5B,MAAM;QACN,MAAM;QACN,MAAM;QACN,UAAU;QACV,UAAU;IACZ;AACF;AAEA,UAAU;AACV,eAAe,YAAY,OAAgB;IACzC,wBAAwB;IACxB,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,MAAM,QAAQ,YAAY,QAAQ,WAAW;IAE7C,eAAe;IACf,IAAI,CAAC,OAAO;QACV,OAAO;YAAE,OAAO;YAAO,OAAO;YAAS,QAAQ;QAAI;IACrD;IAEA,IAAI;QACF,UAAU;QACV,MAAM,YAAY,QAAQ,GAAG,CAAC,UAAU,IAAI;QAC5C,MAAM,UAAU,kJAAG,CAAC,MAAM,CAAC,OAAO;QAMlC,aAAa;QACb,IAAI,QAAQ,IAAI,KAAK,SAAS;YAC5B,OAAO;gBAAE,OAAO;gBAAO,OAAO;gBAAQ,QAAQ;YAAI;QACpD;QAEA,OAAO;YAAE,OAAO;YAAM;QAAQ;IAChC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,YAAY;QAC1B,OAAO;YAAE,OAAO;YAAO,OAAO;YAAS,QAAQ;QAAI;IACrD;AACF;AAEA,YAAY;AACZ,IAAI,cAAmB;AACvB,IAAI,cAAsB;AAC1B,MAAM,iBAAiB,KAAK,MAAM,QAAQ;AAGnC,eAAe,IAAI,OAAgB;IACxC,OAAO;IACP,MAAM,oBAAoB,MAAM,YAAY;IAC5C,IAAI,CAAC,kBAAkB,KAAK,EAAE;QAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO,kBAAkB,KAAK;QAChC,GAAG;YAAE,QAAQ,kBAAkB,MAAM;QAAC;IACxC;IAEA,IAAI;QACF,WAAW;QACX,MAAM,MAAM,KAAK,GAAG;QACpB,IAAI,eAAe,MAAM,aAAa;YACpC,OAAO,gJAAY,CAAC,IAAI,CAAC,aAAa;gBAAE,QAAQ;YAAI;QACtD;QAEA,QAAQ;QACR,MAAM,aAAa,MAAM;QAEzB,WAAW;QACX,MAAM,CAAC,YAAY,GAAG,MAAM,WAAW,OAAO,CAAC;QAC/C,MAAM,CAAC,YAAY,GAAG,MAAM,WAAW,OAAO,CAAC;QAC/C,MAAM,CAAC,eAAe,GAAG,MAAM,WAAW,OAAO,CAAC;QAClD,MAAM,CAAC,iBAAiB,GAAG,MAAM,WAAW,OAAO,CAAC;QAEpD,MAAM,WAAW,GAAG;QAEpB,SAAS;QACT,MAAM,aAAa,AAAC,WAAqB,CAAC,EAAE,CAAC,KAAK;QAClD,MAAM,aAAa,AAAC,WAAqB,CAAC,EAAE,CAAC,KAAK;QAClD,MAAM,gBAAgB,AAAC,cAAwB,CAAC,EAAE,CAAC,KAAK;QACxD,MAAM,kBAAkB,AAAC,gBAA0B,CAAC,EAAE,CAAC,KAAK;QAE5D,SAAS;QACT,MAAM,QAAQ;YACZ;YACA;YACA;YACA;YACA,aAAa,IAAI,OAAO,WAAW;YACnC,YAAY,WAAW,eAAe;QACxC;QAEA,OAAO;QACP,cAAc;QACd,cAAc,MAAM;QAEpB,OAAO,gJAAY,CAAC,IAAI,CAAC,OAAO;YAAE,QAAQ;QAAI;IAChD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gBAAgB;QAE9B,gBAAgB;QAChB,MAAM,gBAAgB;YACpB,YAAY;YACZ,YAAY;YACZ,eAAe;YACf,iBAAiB;YACjB,aAAa,IAAI,OAAO,WAAW;YACnC,YAAY;QACd;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC,eAAe;YAAE,QAAQ;QAAI;IACxD;AACF"}}]
}