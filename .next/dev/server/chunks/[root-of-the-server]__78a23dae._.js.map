{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/MyBlog/LoveandJoy/src/app/admin-secret.ts"],"sourcesContent":["\r\n/**\r\n * 管理员秘钥管理系统\r\n * 用于管理管理员登录秘钥，实现高安全性的管理员认证\r\n */\r\n\r\n/**\r\n * 管理员秘钥管理系统\r\n * 用于管理管理员登录秘钥，实现高安全性的管理员认证\r\n * 注意：当前使用临时解决方案，后续将替换为数据库实现\r\n */\r\n\r\n/**\r\n * 生成随机秘钥\r\n * @param length 秘钥长度\r\n * @returns 随机秘钥\r\n */\r\nexport function generateSecretKey(length = 32): string {\r\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';\r\n  let result = '';\r\n  for (let i = 0; i < length; i++) {\r\n    result += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  return result;\r\n}\r\n\r\n/**\r\n * 获取当前有效秘钥\r\n * @returns 有效秘钥或null\r\n */\r\nexport async function getCurrentSecret(): Promise<string | null> {\r\n  try {\r\n    // 这里使用内存存储作为临时解决方案，后续将替换为数据库查询\r\n    const secret = process.env.ADMIN_SECRET || 'default-secret-key';\r\n    return secret;\r\n  } catch (error) {\r\n    console.error('获取当前秘钥失败:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * 验证秘钥是否有效\r\n * @param secretKey 待验证的秘钥\r\n * @returns 验证结果\r\n */\r\nexport async function validateSecret(secretKey: string): Promise<boolean> {\r\n  try {\r\n    const currentSecret = await getCurrentSecret();\r\n    return secretKey === currentSecret;\r\n  } catch (error) {\r\n    console.error('验证秘钥失败:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * 更新管理员秘钥\r\n * @param updatedBy 更新人ID\r\n * @returns 更新后的秘钥\r\n */\r\nexport async function updateAdminSecret(updatedBy: number | null): Promise<string> {\r\n  try {\r\n    const newSecret = generateSecretKey();\r\n    \r\n    // 这里使用环境变量作为临时解决方案，后续将替换为数据库更新\r\n    console.log('管理员秘钥已更新:', newSecret);\r\n    \r\n    // 发送秘钥更新通知邮件\r\n    await sendSecretUpdateEmail(newSecret);\r\n    \r\n    return newSecret;\r\n  } catch (error) {\r\n    console.error('更新管理员秘钥失败:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 发送秘钥更新邮件\r\n * @param newSecret 新秘钥\r\n */\r\nexport async function sendSecretUpdateEmail(newSecret: string): Promise<void> {\r\n  try {\r\n    const emailData = {\r\n      to: 'kxyatxy116@163.com',\r\n      subject: '【重要】管理员秘钥已更新',\r\n      html: `\r\n        <h2>管理员秘钥更新通知</h2>\r\n        <p>您的管理员秘钥已成功更新，新秘钥如下：</p>\r\n        <p style=\"font-size: 18px; font-weight: bold; color: #333; background: #f0f0f0; padding: 10px; border-radius: 5px;\">${newSecret}</p>\r\n        <p>请妥善保管此秘钥，切勿泄露给他人。</p>\r\n        <p>秘钥有效期：7天</p>\r\n        <p>系统将在秘钥过期前24小时再次提醒您更新。</p>\r\n        <hr>\r\n        <p>此邮件由系统自动发送，请勿回复。</p>\r\n      `\r\n    };\r\n    \r\n    // 调用服务器端API发送邮件\r\n    const response = await fetch('/api/send-email', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify(emailData)\r\n    });\r\n    \r\n    if (response.ok) {\r\n      console.log('秘钥更新邮件已发送');\r\n    } else {\r\n      console.error('发送秘钥更新邮件失败:', await response.json());\r\n    }\r\n  } catch (error) {\r\n    console.error('发送秘钥更新邮件失败:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * 记录登录日志\r\n * @param data 登录日志数据\r\n */\r\nexport async function logLoginAttempt(data: {\r\n  userId?: number;\r\n  username: string;\r\n  ipAddress: string;\r\n  userAgent: string;\r\n  isSuccess: boolean;\r\n  errorMessage?: string;\r\n}): Promise<void> {\r\n  try {\r\n    // 这里使用控制台日志作为临时解决方案，后续将替换为数据库插入\r\n    console.log('登录日志:', data);\r\n  } catch (error) {\r\n    console.error('记录登录日志失败:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * 检查秘钥是否需要更新\r\n * @returns 是否需要更新\r\n */\r\nexport async function checkSecretUpdateNeeded(): Promise<boolean> {\r\n  try {\r\n    // 这里使用固定逻辑作为临时解决方案，后续将替换为数据库查询\r\n    // 实际实现中应检查秘钥创建时间，判断是否需要更新\r\n    return false;\r\n  } catch (error) {\r\n    console.error('检查秘钥更新需求失败:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * 初始化管理员秘钥\r\n */\r\nexport async function initializeAdminSecret(): Promise<void> {\r\n  try {\r\n    // 检查是否已有秘钥\r\n    const currentSecret = await getCurrentSecret();\r\n    if (!currentSecret || currentSecret === 'default-secret-key') {\r\n      // 生成新秘钥\r\n      const newSecret = generateSecretKey();\r\n      console.log('初始化管理员秘钥:', newSecret);\r\n      await sendSecretUpdateEmail(newSecret);\r\n    }\r\n  } catch (error) {\r\n    console.error('初始化管理员秘钥失败:', error);\r\n  }\r\n}\r\n"],"names":[],"mappings":"AACA;;;CAGC,GAED;;;;CAIC,GAED;;;;CAIC;;;;;;;;;;;;;;;;;;AACM,SAAS,kBAAkB,SAAS,EAAE;IAC3C,MAAM,QAAQ;IACd,IAAI,SAAS;IACb,IAAK,IAAI,IAAI,GAAG,IAAI,QAAQ,IAAK;QAC/B,UAAU,MAAM,MAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,MAAM,MAAM;IAChE;IACA,OAAO;AACT;AAMO,eAAe;IACpB,IAAI;QACF,+BAA+B;QAC/B,MAAM,SAAS,QAAQ,GAAG,CAAC,YAAY,IAAI;QAC3C,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,aAAa;QAC3B,OAAO;IACT;AACF;AAOO,eAAe,eAAe,SAAiB;IACpD,IAAI;QACF,MAAM,gBAAgB,MAAM;QAC5B,OAAO,cAAc;IACvB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,WAAW;QACzB,OAAO;IACT;AACF;AAOO,eAAe,kBAAkB,SAAwB;IAC9D,IAAI;QACF,MAAM,YAAY;QAElB,+BAA+B;QAC/B,QAAQ,GAAG,CAAC,aAAa;QAEzB,aAAa;QACb,MAAM,sBAAsB;QAE5B,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,cAAc;QAC5B,MAAM;IACR;AACF;AAMO,eAAe,sBAAsB,SAAiB;IAC3D,IAAI;QACF,MAAM,YAAY;YAChB,IAAI;YACJ,SAAS;YACT,MAAM,CAAC;;;4HAG+G,EAAE,UAAU;;;;;;MAMlI,CAAC;QACH;QAEA,gBAAgB;QAChB,MAAM,WAAW,MAAM,MAAM,mBAAmB;YAC9C,QAAQ;YACR,SAAS;gBACP,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;QACvB;QAEA,IAAI,SAAS,EAAE,EAAE;YACf,QAAQ,GAAG,CAAC;QACd,OAAO;YACL,QAAQ,KAAK,CAAC,eAAe,MAAM,SAAS,IAAI;QAClD;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,eAAe;IAC/B;AACF;AAMO,eAAe,gBAAgB,IAOrC;IACC,IAAI;QACF,gCAAgC;QAChC,QAAQ,GAAG,CAAC,SAAS;IACvB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,aAAa;IAC7B;AACF;AAMO,eAAe;IACpB,IAAI;QACF,+BAA+B;QAC/B,0BAA0B;QAC1B,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,eAAe;QAC7B,OAAO;IACT;AACF;AAKO,eAAe;IACpB,IAAI;QACF,WAAW;QACX,MAAM,gBAAgB,MAAM;QAC5B,IAAI,CAAC,iBAAiB,kBAAkB,sBAAsB;YAC5D,QAAQ;YACR,MAAM,YAAY;YAClB,QAAQ,GAAG,CAAC,aAAa;YACzB,MAAM,sBAAsB;QAC9B;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,eAAe;IAC/B;AACF"}},
    {"offset": {"line": 184, "column": 0}, "map": {"version":3,"sources":["file:///D:/MyBlog/LoveandJoy/src/app/api/admin/credentials/secret-key/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { validateSecret, getCurrentSecret } from '../../../../admin-secret';\r\n\r\n// 模拟日志记录函数\r\nconst logOperation = (action: string, userId: string | null, ipAddress: string, success: boolean, details?: string) => {\r\n  console.log(`[${new Date().toISOString()}] ${action} - User: ${userId}, IP: ${ipAddress}, Success: ${success}, Details: ${details}`);\r\n};\r\n\r\nexport async function PUT(request: Request) {\r\n  try {\r\n    const body = await request.json();\r\n    const { currentKey, newKey } = body;\r\n    \r\n    // 获取客户端IP地址\r\n    const ipAddress = request.headers.get('x-forwarded-for') || request.headers.get('remote-addr') || 'unknown';\r\n    \r\n    // 验证当前密钥\r\n    const isValid = await validateSecret(currentKey);\r\n    if (!isValid) {\r\n      logOperation('Update Admin Secret', null, ipAddress, false, 'Invalid current secret key');\r\n      return NextResponse.json({ error: '当前密钥验证失败' }, { status: 401 });\r\n    }\r\n    \r\n    // 验证新密钥复杂度\r\n    if (newKey.length < 16) {\r\n      logOperation('Update Admin Secret', null, ipAddress, false, 'New secret too short');\r\n      return NextResponse.json({ error: '密钥长度至少为16个字符' }, { status: 400 });\r\n    }\r\n    \r\n    if (!/[A-Z]/.test(newKey)) {\r\n      logOperation('Update Admin Secret', null, ipAddress, false, 'New secret missing uppercase letter');\r\n      return NextResponse.json({ error: '密钥必须包含至少一个大写字母' }, { status: 400 });\r\n    }\r\n    \r\n    if (!/[a-z]/.test(newKey)) {\r\n      logOperation('Update Admin Secret', null, ipAddress, false, 'New secret missing lowercase letter');\r\n      return NextResponse.json({ error: '密钥必须包含至少一个小写字母' }, { status: 400 });\r\n    }\r\n    \r\n    if (!/[0-9]/.test(newKey)) {\r\n      logOperation('Update Admin Secret', null, ipAddress, false, 'New secret missing number');\r\n      return NextResponse.json({ error: '密钥必须包含至少一个数字' }, { status: 400 });\r\n    }\r\n    \r\n    if (!/[^A-Za-z0-9]/.test(newKey)) {\r\n      logOperation('Update Admin Secret', null, ipAddress, false, 'New secret missing special character');\r\n      return NextResponse.json({ error: '密钥必须包含至少一个特殊字符' }, { status: 400 });\r\n    }\r\n    \r\n    // 这里应该是更新数据库中的密钥，目前使用环境变量模拟\r\n    console.log('管理员密钥已更新:', newKey);\r\n    \r\n    // 记录操作日志\r\n    logOperation('Update Admin Secret', null, ipAddress, true, 'Secret key updated successfully');\r\n    \r\n    // 发送密钥更新通知邮件\r\n    try {\r\n      await fetch('/api/send-email', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          to: 'kxyatxy116@163.com',\r\n          subject: '【重要】管理员密钥已更新',\r\n          html: `\r\n            <h2>管理员密钥更新通知</h2>\r\n            <p>您的管理员密钥已成功更新，新密钥如下：</p>\r\n            <p style=\"font-size: 18px; font-weight: bold; color: #333; background: #f0f0f0; padding: 10px; border-radius: 5px;\">${newKey}</p>\r\n            <p>请妥善保管此密钥，切勿泄露给他人。</p>\r\n            <hr>\r\n            <p>此邮件由系统自动发送，请勿回复。</p>\r\n          `\r\n        })\r\n      });\r\n    } catch (emailError) {\r\n      console.error('发送密钥更新邮件失败:', emailError);\r\n    }\r\n    \r\n    return NextResponse.json({ success: true, message: '管理员密钥更新成功' });\r\n  } catch (error) {\r\n    console.error('更新管理员密钥失败:', error);\r\n    return NextResponse.json({ error: '更新失败，请稍后重试' }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,WAAW;AACX,MAAM,eAAe,CAAC,QAAgB,QAAuB,WAAmB,SAAkB;IAChG,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,IAAI,OAAO,WAAW,GAAG,EAAE,EAAE,OAAO,SAAS,EAAE,OAAO,MAAM,EAAE,UAAU,WAAW,EAAE,QAAQ,WAAW,EAAE,SAAS;AACrI;AAEO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,UAAU,EAAE,MAAM,EAAE,GAAG;QAE/B,YAAY;QACZ,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB,QAAQ,OAAO,CAAC,GAAG,CAAC,kBAAkB;QAElG,SAAS;QACT,MAAM,UAAU,MAAM,IAAA,iJAAc,EAAC;QACrC,IAAI,CAAC,SAAS;YACZ,aAAa,uBAAuB,MAAM,WAAW,OAAO;YAC5D,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAW,GAAG;gBAAE,QAAQ;YAAI;QAChE;QAEA,WAAW;QACX,IAAI,OAAO,MAAM,GAAG,IAAI;YACtB,aAAa,uBAAuB,MAAM,WAAW,OAAO;YAC5D,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,IAAI,CAAC,QAAQ,IAAI,CAAC,SAAS;YACzB,aAAa,uBAAuB,MAAM,WAAW,OAAO;YAC5D,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,IAAI,CAAC,QAAQ,IAAI,CAAC,SAAS;YACzB,aAAa,uBAAuB,MAAM,WAAW,OAAO;YAC5D,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,IAAI,CAAC,QAAQ,IAAI,CAAC,SAAS;YACzB,aAAa,uBAAuB,MAAM,WAAW,OAAO;YAC5D,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,IAAI,CAAC,eAAe,IAAI,CAAC,SAAS;YAChC,aAAa,uBAAuB,MAAM,WAAW,OAAO;YAC5D,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,4BAA4B;QAC5B,QAAQ,GAAG,CAAC,aAAa;QAEzB,SAAS;QACT,aAAa,uBAAuB,MAAM,WAAW,MAAM;QAE3D,aAAa;QACb,IAAI;YACF,MAAM,MAAM,mBAAmB;gBAC7B,QAAQ;gBACR,SAAS;oBACP,gBAAgB;gBAClB;gBACA,MAAM,KAAK,SAAS,CAAC;oBACnB,IAAI;oBACJ,SAAS;oBACT,MAAM,CAAC;;;gIAG+G,EAAE,OAAO;;;;UAI/H,CAAC;gBACH;YACF;QACF,EAAE,OAAO,YAAY;YACnB,QAAQ,KAAK,CAAC,eAAe;QAC/B;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,SAAS;QAAY;IACjE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,cAAc;QAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAa,GAAG;YAAE,QAAQ;QAAI;IAClE;AACF"}}]
}