module.exports=[78130,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944),e=a.i(38246),f=a.i(50247),g=a.i(25118);let h=async()=>{try{let a=await fetch("/api/users");if(!a.ok)throw Error("获取用户数据失败");return await a.json()}catch(a){return console.error("获取用户数据失败:",a),[]}};function i(){let a=(0,d.useRouter)(),[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)(""),[m,n]=(0,c.useState)([]),[o,p]=(0,c.useState)(!1),[q,r]=(0,c.useState)(""),[s,t]=(0,c.useState)(1),[u]=(0,c.useState)(10),[v,w]=(0,c.useState)(!1),[x,y]=(0,c.useState)(null),[z,A]=(0,c.useState)({}),[B,C]=(0,c.useState)({}),[D,E]=(0,c.useState)(""),[F,G]=(0,c.useState)(!1),[H,I]=(0,c.useState)("");(0,c.useEffect)(()=>{let b=()=>{let b=g.adminAuth.isAuthenticated(),c=g.adminAuth.getCurrentUser();if(!b||!c||"admin"!==c.role)return void a.push("/admin/secret-login")};return b(),(0,g.listenToAdminStateChanges)(b)},[a]);let J=async()=>{let a=await h();j(a),n(a)};(0,c.useEffect)(()=>{J()},[]),(0,c.useEffect)(()=>{let a=setInterval(()=>{J()},36e5);return()=>clearInterval(a)},[]),(0,c.useEffect)(()=>{let a=[...i];if(""!==k.trim()){let b=k.toLowerCase();a=a.filter(a=>a.name.toLowerCase().includes(b)||a.email.toLowerCase().includes(b))}n(a=o?a.filter(a=>a.inactive):a.filter(a=>!a.inactive)),t(1)},[k,i,o]);let K=s*u,L=m.slice(K-u,K),M=Math.ceil(m.length/u),N=()=>{w(!1),y(null),A({}),E(""),C({})},O=async a=>{let b=a.target.files?.[0];if(b){if(b.size>3145728){I(`图片大小超过限制（最大3MB），请重新选择图片`),E(""),A(a=>({...a,avatar:""}));return}let a=new FormData;a.append("file",b);try{let b=await fetch("/api/upload",{method:"POST",body:a});if(!b.ok){let a=await b.json().catch(()=>({}));throw Error(a.error||"头像上传失败")}let c=await b.json();E(c.url),A(a=>({...a,avatar:c.url})),I("")}catch(a){I(a.message||"头像上传失败，请稍后重试"),E(""),A(a=>({...a,avatar:""}))}}},P=async()=>{let a={};if(H&&(a.avatar=H),z.name?.trim()){let b=(0,f.detectSensitiveWords)(z.name);b.length>0&&(a.name=`姓名包含违禁词: ${b.join(", ")}`)}else a.name="请输入姓名";if(z.email?.trim())if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(z.email)){let b=(0,f.detectSensitiveWords)(z.email);b.length>0&&(a.email=`邮箱包含违禁词: ${b.join(", ")}`)}else a.email="请输入有效的邮箱地址";else a.email="请输入邮箱";if(z.usernameId?.trim()){let b=(0,f.detectSensitiveWords)(z.usernameId);b.length>0&&(a.usernameId=`用户名ID包含违禁词: ${b.join(", ")}`)}else a.usernameId="请输入用户名ID";return F?z.password?.trim()?/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(z.password)||(a.password="密码长度至少为8个字符，包含大小写字母、数字和特殊符号"):a.password="请输入初始密码":z.newPassword&&(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(z.newPassword)||(a.newPassword="密码长度至少为8个字符，包含大小写字母、数字和特殊符号"),z.newPassword!==z.confirmPassword&&(a.confirmPassword="两次输入的密码不一致")),C(a),0===Object.keys(a).length},Q=async()=>{if(await P())try{let a,b=z.avatar||"https://via.placeholder.com/100";b.startsWith("data:")&&b.length>1048576&&(b="https://via.placeholder.com/100");let c={name:z.name||"",email:z.email||"",usernameId:z.usernameId||"",avatar:b,role:z.role||"user"};if(z.newPassword&&(c.password=z.newPassword),F?(a=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}),r("用户添加成功")):(a=await fetch(`/api/users/${x?.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}),r("用户信息更新成功")),!a.ok){let b=await a.json().catch(()=>({}));throw console.error("保存用户失败的详细信息:",b),console.error("响应状态:",a.status),console.error("请求体:",JSON.stringify(c)),Error(b.error||b.message||`保存用户失败，状态码: ${a.status}`)}N(),J(),setTimeout(()=>r(""),3e3)}catch(a){console.error("保存用户信息失败:",a),C({general:a instanceof Error?a.message:"保存用户信息失败，请稍后重试"})}},R=async a=>{try{let b=await fetch(`/api/users/${a}/posts/count`),c=(await b.json()).count||0,d=!1;if((d=c>0?confirm(`该用户还有${c}篇管理博文未删除，是否确认删除？删除用户将同时删除所有关联的博文。`):confirm("确定要删除这个用户吗？"))&&(d=confirm("确定要执行删除操作吗？此操作不可恢复，将删除用户及其所有关联数据。")),d){let b=await fetch(`/api/users/${a}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({deletePosts:!0})});if(!b.ok){let a=await b.json().catch(()=>({})),c=a.message||a.error||"删除用户失败";throw Error(c)}r("用户已删除"),J(),setTimeout(()=>r(""),3e3)}}catch(a){console.error("删除用户失败:",a),r(a instanceof Error?a.message:"删除用户失败，请稍后重试"),setTimeout(()=>r(""),3e3)}};return(0,b.jsx)("div",{className:"min-h-[calc(100vh-200px)] bg-gray-50",children:(0,b.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center mb-8",children:[(0,b.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"用户管理"}),(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)("button",{onClick:()=>p(!o),className:`px-4 py-2 rounded-md text-sm font-medium transition-colors ${o?"bg-red-600 hover:bg-red-700 text-white":"bg-gray-200 hover:bg-gray-300 text-gray-700"}`,children:o?"活跃用户":"不活跃用户"}),(0,b.jsx)("button",{onClick:async()=>{try{let a=await fetch("/api/users/check-inactive",{method:"POST"}),b=await a.json();b.success?(r(`成功标记 ${b.affectedRows} 个不活跃用户`),J()):r("检查不活跃用户失败"),setTimeout(()=>r(""),3e3)}catch(a){console.error("检查不活跃用户失败:",a),r("检查不活跃用户失败"),setTimeout(()=>r(""),3e3)}},className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md text-sm font-medium transition-colors",children:"检查不活跃用户"}),(0,b.jsx)("button",{onClick:()=>{y(null),A({}),E(""),C({}),G(!0),w(!0)},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors",children:"添加用户"}),(0,b.jsx)(e.default,{href:"/admin",className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md text-sm font-medium transition-colors",children:"返回后台"})]})]}),q&&(0,b.jsx)("div",{className:"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-md mb-6",children:q}),(0,b.jsx)("div",{className:"mb-8",children:(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)("input",{type:"text",placeholder:"搜索用户名、邮箱或姓名...",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",value:k,onChange:a=>l(a.target.value)}),(0,b.jsx)("div",{className:"absolute right-3 top-3",children:(0,b.jsx)("svg",{className:"w-5 h-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,b.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})})]})}),(0,b.jsxs)("div",{className:"bg-white rounded-xl shadow-md overflow-hidden",children:[(0,b.jsx)("div",{className:"overflow-x-auto",children:(0,b.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,b.jsx)("thead",{className:"bg-gray-50",children:(0,b.jsxs)("tr",{children:[(0,b.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"用户ID"}),(0,b.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"用户信息"}),(0,b.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"邮箱"}),(0,b.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"角色"}),(0,b.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"注册时间"}),(0,b.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"操作"})]})}),(0,b.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:L.map(a=>(0,b.jsxs)("tr",{className:a.inactive?"bg-gray-50":"",children:[(0,b.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:a.id}),(0,b.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,b.jsxs)("div",{className:"flex items-center",children:[(0,b.jsx)("div",{className:"w-10 h-10 rounded-full overflow-hidden mr-3",children:(0,b.jsx)("img",{src:a.avatar,alt:a.name,className:"w-full h-full object-cover"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-sm font-medium text-gray-900",children:a.name}),a.inactive&&(0,b.jsx)("div",{className:"text-xs text-red-500 mt-1",children:"不活跃"})]})]})}),(0,b.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:a.email}),(0,b.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,b.jsx)("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${"admin"===a.role?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"}`,children:"admin"===a.role?"管理员":"普通用户"})}),(0,b.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(a.createdAt).toISOString().slice(0,19).replace("T"," ")}),(0,b.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsx)("button",{onClick:()=>{y(a),A(a),E(a.avatar),C({}),G(!1),w(!0)},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors",children:"修改"}),(0,b.jsx)("button",{onClick:()=>R(a.id),className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm font-medium transition-colors",children:"删除"})]})})]},a.id))})]})}),M>1&&(0,b.jsx)("div",{className:"px-6 py-4 bg-white border-t border-gray-200",children:(0,b.jsxs)("div",{className:"flex justify-center items-center space-x-2",children:[(0,b.jsx)("button",{onClick:()=>{s>1&&t(s-1)},disabled:1===s,className:"px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"上一页"}),Array.from({length:M},(a,b)=>b+1).map(a=>(0,b.jsx)("button",{onClick:()=>{t(a)},className:`px-3 py-1 border rounded-md text-sm font-medium transition-colors ${s===a?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50"}`,children:a},a)),(0,b.jsx)("button",{onClick:()=>{s<M&&t(s+1)},disabled:s===M,className:"px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"下一页"})]})}),0===m.length&&(0,b.jsxs)("div",{className:"px-6 py-12 text-center",children:[(0,b.jsx)("svg",{className:"w-12 h-12 text-gray-400 mx-auto mb-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,b.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"})}),(0,b.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"没有找到用户"}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:k?"尝试调整搜索条件":"还没有用户"})]})]}),v&&(0,b.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:(0,b.jsxs)("div",{className:"bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center px-6 py-4 border-b border-gray-200",children:[(0,b.jsx)("h2",{className:"text-xl font-bold text-gray-900",children:F?"添加用户":"编辑用户"}),(0,b.jsx)("button",{onClick:N,className:"text-gray-400 hover:text-gray-600",children:(0,b.jsx)("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,b.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,b.jsx)("div",{className:"px-6 py-6",children:(0,b.jsxs)("form",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex flex-col items-center",children:[(0,b.jsx)("div",{className:"w-24 h-24 rounded-full overflow-hidden border-2 border-gray-200 mb-4",children:(0,b.jsx)("img",{src:D||"https://via.placeholder.com/100",alt:"用户头像",className:"w-full h-full object-cover"})}),(0,b.jsx)("input",{type:"file",accept:"image/*",onChange:O,className:"mb-2"}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"点击上传头像，支持 JPG、PNG 格式"}),H&&(0,b.jsx)("p",{className:"mt-1 text-sm text-red-600",children:H}),B.avatar&&(0,b.jsx)("p",{className:"mt-1 text-sm text-red-600",children:B.avatar})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 mb-1",children:"姓名"}),(0,b.jsx)("input",{type:"text",id:"name",value:z.name||"",onChange:a=>A(b=>({...b,name:a.target.value})),className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${B.name?"border-red-500":"border-gray-300"}`,placeholder:"请输入姓名"}),B.name&&(0,b.jsx)("p",{className:"mt-1 text-sm text-red-600",children:B.name})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"邮箱"}),(0,b.jsx)("input",{type:"email",id:"email",value:z.email||"",onChange:a=>A(b=>({...b,email:a.target.value})),className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${B.email?"border-red-500":"border-gray-300"}`,placeholder:"请输入邮箱"}),B.email&&(0,b.jsx)("p",{className:"mt-1 text-sm text-red-600",children:B.email})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"usernameId",className:"block text-sm font-medium text-gray-700 mb-1",children:"用户名ID"}),(0,b.jsx)("input",{type:"text",id:"usernameId",value:z.usernameId||"",onChange:a=>A(b=>({...b,usernameId:a.target.value})),className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${B.usernameId?"border-red-500":"border-gray-300"}`,placeholder:"请输入用户名ID"}),B.usernameId&&(0,b.jsx)("p",{className:"mt-1 text-sm text-red-600",children:B.usernameId})]}),F?(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-1",children:"初始密码"}),(0,b.jsx)("input",{type:"password",id:"password",value:z.password||"",onChange:a=>A(b=>({...b,password:a.target.value})),className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${B.password?"border-red-500":"border-gray-300"}`,placeholder:"请输入初始密码"}),B.password&&(0,b.jsx)("p",{className:"mt-1 text-sm text-red-600",children:B.password})]}):(0,b.jsxs)("div",{children:[(0,b.jsx)("h3",{className:"text-sm font-medium text-gray-700 mb-2",children:"修改密码（可选）"}),(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"newPassword",className:"block text-sm font-medium text-gray-700 mb-1",children:"新密码"}),(0,b.jsx)("input",{type:"password",id:"newPassword",value:z.newPassword||"",onChange:a=>A(b=>({...b,newPassword:a.target.value})),className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${B.newPassword?"border-red-500":"border-gray-300"}`,placeholder:"请输入新密码"}),B.newPassword&&(0,b.jsx)("p",{className:"mt-1 text-sm text-red-600",children:B.newPassword})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"confirmPassword",className:"block text-sm font-medium text-gray-700 mb-1",children:"确认新密码"}),(0,b.jsx)("input",{type:"password",id:"confirmPassword",value:z.confirmPassword||"",onChange:a=>A(b=>({...b,confirmPassword:a.target.value})),className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${B.confirmPassword?"border-red-500":"border-gray-300"}`,placeholder:"请再次输入新密码"}),B.confirmPassword&&(0,b.jsx)("p",{className:"mt-1 text-sm text-red-600",children:B.confirmPassword})]})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"role",className:"block text-sm font-medium text-gray-700 mb-1",children:"角色"}),(0,b.jsxs)("select",{id:"role",value:z.role||"user",onChange:a=>A(b=>({...b,role:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[(0,b.jsx)("option",{value:"user",children:"普通用户"}),(0,b.jsx)("option",{value:"admin",children:"管理员"})]})]})]})}),(0,b.jsxs)("div",{className:"px-6 py-4 border-t border-gray-200 flex justify-end gap-3",children:[(0,b.jsx)("button",{onClick:N,className:"px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors",children:"取消"}),(0,b.jsx)("button",{onClick:Q,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors",children:F?"添加用户":"保存修改"})]})]})})]})})}a.s(["default",()=>i])}];

//# sourceMappingURL=src_app_admin_users_page_tsx_aef2c918._.js.map