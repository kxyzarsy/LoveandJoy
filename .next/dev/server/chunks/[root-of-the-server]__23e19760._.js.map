{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///D:/MyBlog/LoveandJoy/src/app/api/users/check-inactive/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport mysql from 'mysql2/promise';\r\n\r\n// 创建数据库连接\r\nasync function createConnection() {\r\n  return mysql.createConnection({\r\n    host: 'localhost',\r\n    port: 3306,\r\n    user: 'root',\r\n    password: '123456',\r\n    database: 'yueblog'\r\n  });\r\n}\r\n\r\n// 检查并标记不活跃用户\r\nexport async function POST() {\r\n  try {\r\n    const connection = await createConnection();\r\n    \r\n    // 记录开始时间\r\n    const startTime = new Date();\r\n    console.log(`[${startTime.toISOString()}] 开始检查不活跃用户`);\r\n    \r\n    // 标记连续30天未登录的用户为不活跃\r\n    const [result] = await connection.execute(\r\n      `UPDATE user \r\n       SET inactive = true \r\n       WHERE lastLoginAt < DATE_SUB(NOW(), INTERVAL 30 DAY) \r\n       AND inactive = false`\r\n    );\r\n    \r\n    // 标记最近30天登录的用户为活跃\r\n    await connection.execute(\r\n      `UPDATE user \r\n       SET inactive = false \r\n       WHERE lastLoginAt >= DATE_SUB(NOW(), INTERVAL 30 DAY) \r\n       AND inactive = true`\r\n    );\r\n    \r\n    await connection.end();\r\n    \r\n    // 记录结束时间和结果\r\n    const endTime = new Date();\r\n    const affectedRows = (result as any).affectedRows || 0;\r\n    console.log(`[${endTime.toISOString()}] 不活跃用户检查完成，共标记 ${affectedRows} 个用户为不活跃状态`);\r\n    \r\n    return NextResponse.json({\r\n      success: true,\r\n      message: '不活跃用户检查完成',\r\n      affectedRows,\r\n      startTime: startTime.toISOString(),\r\n      endTime: endTime.toISOString()\r\n    }, { status: 200 });\r\n  } catch (error) {\r\n    console.error('检查不活跃用户失败:', error);\r\n    return NextResponse.json(\r\n      { success: false, message: '检查不活跃用户失败', error: (error as Error).message }, \r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// 获取不活跃用户统计\r\nexport async function GET() {\r\n  try {\r\n    const connection = await createConnection();\r\n    \r\n    // 获取不活跃用户数量\r\n    const [inactiveCountResult] = await connection.execute(\r\n      'SELECT COUNT(*) as inactiveCount FROM user WHERE inactive = true'\r\n    );\r\n    \r\n    // 获取活跃用户数量\r\n    const [activeCountResult] = await connection.execute(\r\n      'SELECT COUNT(*) as activeCount FROM user WHERE inactive = false'\r\n    );\r\n    \r\n    // 获取总用户数量\r\n    const [totalCountResult] = await connection.execute(\r\n      'SELECT COUNT(*) as totalCount FROM user'\r\n    );\r\n    \r\n    await connection.end();\r\n    \r\n    const inactiveCount = (inactiveCountResult as any)[0].inactiveCount;\r\n    const activeCount = (activeCountResult as any)[0].activeCount;\r\n    const totalCount = (totalCountResult as any)[0].totalCount;\r\n    \r\n    return NextResponse.json({\r\n      success: true,\r\n      data: {\r\n        inactiveCount,\r\n        activeCount,\r\n        totalCount,\r\n        inactivePercentage: totalCount > 0 ? Math.round((inactiveCount / totalCount) * 100) : 0\r\n      }\r\n    }, { status: 200 });\r\n  } catch (error) {\r\n    console.error('获取不活跃用户统计失败:', error);\r\n    return NextResponse.json(\r\n      { success: false, message: '获取不活跃用户统计失败', error: (error as Error).message }, \r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,UAAU;AACV,eAAe;IACb,OAAO,8IAAK,CAAC,gBAAgB,CAAC;QAC5B,MAAM;QACN,MAAM;QACN,MAAM;QACN,UAAU;QACV,UAAU;IACZ;AACF;AAGO,eAAe;IACpB,IAAI;QACF,MAAM,aAAa,MAAM;QAEzB,SAAS;QACT,MAAM,YAAY,IAAI;QACtB,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,UAAU,WAAW,GAAG,WAAW,CAAC;QAEpD,oBAAoB;QACpB,MAAM,CAAC,OAAO,GAAG,MAAM,WAAW,OAAO,CACvC,CAAC;;;2BAGoB,CAAC;QAGxB,kBAAkB;QAClB,MAAM,WAAW,OAAO,CACtB,CAAC;;;0BAGmB,CAAC;QAGvB,MAAM,WAAW,GAAG;QAEpB,YAAY;QACZ,MAAM,UAAU,IAAI;QACpB,MAAM,eAAe,AAAC,OAAe,YAAY,IAAI;QACrD,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,QAAQ,WAAW,GAAG,gBAAgB,EAAE,aAAa,UAAU,CAAC;QAEhF,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;YACT;YACA,WAAW,UAAU,WAAW;YAChC,SAAS,QAAQ,WAAW;QAC9B,GAAG;YAAE,QAAQ;QAAI;IACnB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,cAAc;QAC5B,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,SAAS;YAAa,OAAO,AAAC,MAAgB,OAAO;QAAC,GACxE;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe;IACpB,IAAI;QACF,MAAM,aAAa,MAAM;QAEzB,YAAY;QACZ,MAAM,CAAC,oBAAoB,GAAG,MAAM,WAAW,OAAO,CACpD;QAGF,WAAW;QACX,MAAM,CAAC,kBAAkB,GAAG,MAAM,WAAW,OAAO,CAClD;QAGF,UAAU;QACV,MAAM,CAAC,iBAAiB,GAAG,MAAM,WAAW,OAAO,CACjD;QAGF,MAAM,WAAW,GAAG;QAEpB,MAAM,gBAAgB,AAAC,mBAA2B,CAAC,EAAE,CAAC,aAAa;QACnE,MAAM,cAAc,AAAC,iBAAyB,CAAC,EAAE,CAAC,WAAW;QAC7D,MAAM,aAAa,AAAC,gBAAwB,CAAC,EAAE,CAAC,UAAU;QAE1D,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ;gBACA;gBACA;gBACA,oBAAoB,aAAa,IAAI,KAAK,KAAK,CAAC,AAAC,gBAAgB,aAAc,OAAO;YACxF;QACF,GAAG;YAAE,QAAQ;QAAI;IACnB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,SAAS;YAAe,OAAO,AAAC,MAAgB,OAAO;QAAC,GAC1E;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}