{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///D:/MyBlog/LoveandJoy/src/app/api/users/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport mysql from 'mysql2/promise';\nimport bcrypt from 'bcrypt';\n\n// 创建数据库连接\nasync function createConnection() {\n  return mysql.createConnection({\n    host: 'localhost',\n    port: 3306,\n    user: 'root',\n    password: '123456',\n    database: 'yueblog'\n  });\n}\n\n// 获取所有用户\nexport async function GET() {\n  try {\n    const connection = await createConnection();\n    const [rows] = await connection.execute('SELECT id, name, email, usernameId, avatar, backgroundImage, bio, role, inactive, createdAt, updatedAt FROM user');\n    await connection.end();\n    \n    // 计算每个用户的剩余用户名修改时间\n    const usersWithRemainingTime = (rows as any[]).map(user => {\n      let remainingHours = 0;\n      if (user.lastUsernameChange) {\n        const lastChangeTime = new Date(user.lastUsernameChange);\n        const now = new Date();\n        const diffHours = (now.getTime() - lastChangeTime.getTime()) / (1000 * 60 * 60);\n        remainingHours = Math.max(0, Math.ceil(720 - diffHours));\n      }\n      return {\n        ...user,\n        remainingUsernameChangeHours: remainingHours\n      };\n    });\n    \n    return NextResponse.json(usersWithRemainingTime, { status: 200 });\n  } catch (error) {\n    console.error('获取用户数据失败:', error);\n    return NextResponse.json({ error: '获取用户数据失败' }, { status: 500 });\n  }\n}\n\n// 添加新用户\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const { name, email, password, usernameId, avatar, bio, role } = body;\n\n    const connection = await createConnection();\n    \n    // 检查用户名ID是否已存在\n    const [existingUserRows] = await connection.execute(\n      'SELECT id FROM user WHERE usernameId = ?',\n      [usernameId]\n    );\n    \n    if ((existingUserRows as any).length > 0) {\n      await connection.end();\n      return NextResponse.json({\n        error: '用户名ID已存在',\n        message: '该用户名ID已被其他用户使用，请选择其他ID'\n      }, { status: 400 });\n    }\n    \n    // 检查必填字段\n    if (!name || !email || !password || !usernameId) {\n      await connection.end();\n      return NextResponse.json({ \n        error: '缺少必填字段',\n        message: 'name, email, password和usernameId是必填字段'\n      }, { status: 400 });\n    }\n    \n    // 加密密码\n    const hashedPassword = await bcrypt.hash(password, 10);\n    \n    const [result] = await connection.execute(\n      'INSERT INTO user (name, email, password, usernameId, avatar, bio, role, createdAt, updatedAt) VALUES (?, ?, ?, ?, ?, ?, ?, NOW(), NOW())',\n      [name, email, hashedPassword, usernameId, avatar || null, bio || null, role || 'user']\n    );\n    \n    const [newUser] = await connection.execute(\n      'SELECT id, name, email, usernameId, avatar, backgroundImage, bio, role, inactive, createdAt, updatedAt FROM user WHERE id = ?',\n      [(result as any).insertId]\n    );\n    \n    await connection.end();\n    \n    const createdUser = (newUser as any)[0];\n    return NextResponse.json({\n      ...createdUser,\n      remainingUsernameChangeHours: 0 // 新用户可以立即修改用户名ID\n    }, { status: 201 });\n  } catch (error) {\n    console.error('添加用户失败:', error);\n    return NextResponse.json({ error: '添加用户失败', details: (error as Error).message }, { status: 500 });\n  }\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEA,UAAU;AACV,eAAe;IACb,OAAO,8IAAK,CAAC,gBAAgB,CAAC;QAC5B,MAAM;QACN,MAAM;QACN,MAAM;QACN,UAAU;QACV,UAAU;IACZ;AACF;AAGO,eAAe;IACpB,IAAI;QACF,MAAM,aAAa,MAAM;QACzB,MAAM,CAAC,KAAK,GAAG,MAAM,WAAW,OAAO,CAAC;QACxC,MAAM,WAAW,GAAG;QAEpB,mBAAmB;QACnB,MAAM,yBAAyB,AAAC,KAAe,GAAG,CAAC,CAAA;YACjD,IAAI,iBAAiB;YACrB,IAAI,KAAK,kBAAkB,EAAE;gBAC3B,MAAM,iBAAiB,IAAI,KAAK,KAAK,kBAAkB;gBACvD,MAAM,MAAM,IAAI;gBAChB,MAAM,YAAY,CAAC,IAAI,OAAO,KAAK,eAAe,OAAO,EAAE,IAAI,CAAC,OAAO,KAAK,EAAE;gBAC9E,iBAAiB,KAAK,GAAG,CAAC,GAAG,KAAK,IAAI,CAAC,MAAM;YAC/C;YACA,OAAO;gBACL,GAAG,IAAI;gBACP,8BAA8B;YAChC;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC,wBAAwB;YAAE,QAAQ;QAAI;IACjE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,aAAa;QAC3B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAW,GAAG;YAAE,QAAQ;QAAI;IAChE;AACF;AAGO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,QAAQ,EAAE,UAAU,EAAE,MAAM,EAAE,GAAG,EAAE,IAAI,EAAE,GAAG;QAEjE,MAAM,aAAa,MAAM;QAEzB,eAAe;QACf,MAAM,CAAC,iBAAiB,GAAG,MAAM,WAAW,OAAO,CACjD,4CACA;YAAC;SAAW;QAGd,IAAI,AAAC,iBAAyB,MAAM,GAAG,GAAG;YACxC,MAAM,WAAW,GAAG;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;gBACP,SAAS;YACX,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,SAAS;QACT,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,YAAY,CAAC,YAAY;YAC/C,MAAM,WAAW,GAAG;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;gBACP,SAAS;YACX,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,OAAO;QACP,MAAM,iBAAiB,MAAM,gHAAM,CAAC,IAAI,CAAC,UAAU;QAEnD,MAAM,CAAC,OAAO,GAAG,MAAM,WAAW,OAAO,CACvC,4IACA;YAAC;YAAM;YAAO;YAAgB;YAAY,UAAU;YAAM,OAAO;YAAM,QAAQ;SAAO;QAGxF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CACxC,iIACA;YAAE,OAAe,QAAQ;SAAC;QAG5B,MAAM,WAAW,GAAG;QAEpB,MAAM,cAAc,AAAC,OAAe,CAAC,EAAE;QACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,GAAG,WAAW;YACd,8BAA8B,EAAE,iBAAiB;QACnD,GAAG;YAAE,QAAQ;QAAI;IACnB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,WAAW;QACzB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;YAAU,SAAS,AAAC,MAAgB,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACjG;AACF"}}]
}