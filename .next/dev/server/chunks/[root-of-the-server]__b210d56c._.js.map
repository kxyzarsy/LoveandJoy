{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///D:/MyBlog/LoveandJoy/src/utils/emailService.ts"],"sourcesContent":["import nodemailer from 'nodemailer';\n\n// 邮件配置 - 根据发件人邮箱选择不同的配置\nconst emailConfigs = {\n  '163.com': {\n    service: '163',\n    host: 'smtp.163.com',\n    port: 465,\n    secure: true,\n    auth: {\n      user: process.env.EMAIL_163_USER || 'your-email@163.com',\n      pass: process.env.EMAIL_163_PASS || 'BM5YWbFScfXxEuyD' // 网易邮箱授权码\n    }\n  },\n  'qq.com': {\n    service: 'qq',\n    host: 'smtp.qq.com',\n    port: 465,\n    secure: true,\n    auth: {\n      user: process.env.EMAIL_QQ_USER || 'your-email@qq.com',\n      pass: process.env.EMAIL_QQ_PASS || 'wxjhixyhgmnechgg' // QQ邮箱授权码\n    }\n  }\n};\n\n// 创建邮件传输器工厂函数\nconst createTransporter = (fromEmail: string) => {\n  const emailDomain = fromEmail.split('@')[1];\n  const config = emailConfigs[emailDomain as keyof typeof emailConfigs] || emailConfigs['qq.com'];\n  return nodemailer.createTransport(config);\n};\n\n// 发送验证码邮件\nexport const sendVerificationEmail = async (\n  to: string,\n  code: string,\n  subject: string = '注册验证码'\n): Promise<{ success: boolean; message: string }> => {\n  try {\n    // 选择发件人邮箱（根据收件人邮箱选择对应服务商的发件人）\n    const toDomain = to.split('@')[1];\n    let fromEmail: string;\n    let configKey: keyof typeof emailConfigs;\n    \n    if (toDomain === '163.com' || toDomain === '126.com' || toDomain === 'yeah.net') {\n      fromEmail = process.env.EMAIL_163_USER || 'kxyatxy116@163.com';\n      configKey = '163.com';\n    } else {\n      fromEmail = process.env.EMAIL_QQ_USER || '1962941753@qq.com';\n      configKey = 'qq.com';\n    }\n    \n    // 获取配置\n    const config = emailConfigs[configKey];\n    \n    if (!config) {\n      throw new Error(`未找到${configKey}的邮箱配置`);\n    }\n    \n    // 使用环境变量覆盖配置\n    const finalConfig = {\n      ...config,\n      auth: {\n        user: configKey === '163.com' ? process.env.EMAIL_163_USER || config.auth.user : process.env.EMAIL_QQ_USER || config.auth.user,\n        pass: configKey === '163.com' ? process.env.EMAIL_163_PASS || config.auth.pass : process.env.EMAIL_QQ_PASS || config.auth.pass\n      }\n    };\n    \n    // 验证配置\n    if (!finalConfig.auth.user || !finalConfig.auth.pass) {\n      throw new Error('邮件配置不完整，请检查环境变量');\n    }\n    \n\n\n    // 创建邮件传输器\n    const transporter = nodemailer.createTransport(finalConfig);\n    \n    // 验证连接\n    try {\n      await transporter.verify();\n\n    } catch (verifyError) {\n      console.error('SMTP连接验证失败:', verifyError);\n      throw new Error(`SMTP连接验证失败: ${verifyError instanceof Error ? verifyError.message : '未知错误'}`);\n    }\n\n    // 构建邮件内容\n    const mailOptions = {\n      from: {\n        name: 'Love and Joy Blog',\n        address: finalConfig.auth.user\n      },\n      to,\n      subject,\n      html: `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <h2 style=\"color: #333; text-align: center;\">注册验证码</h2>\n          <div style=\"background: #f8f9fa; padding: 30px; border-radius: 8px; margin: 20px 0;\">\n            <p style=\"font-size: 16px; color: #555; margin-bottom: 20px;\">您好，</p>\n            <p style=\"font-size: 16px; color: #555; margin-bottom: 20px;\">您正在注册 Love and Joy Blog 账户，您的验证码是：</p>\n            <div style=\"text-align: center; margin: 30px 0;\">\n              <span style=\"font-size: 32px; font-weight: bold; color: #1a73e8; letter-spacing: 4px;\">${code}</span>\n            </div>\n            <p style=\"font-size: 14px; color: #666; margin-top: 30px;\">验证码有效期为30分钟，请尽快使用。</p>\n            <p style=\"font-size: 14px; color: #666; margin-top: 10px;\">如果您没有请求此验证码，请忽略此邮件。</p>\n          </div>\n          <p style=\"font-size: 12px; color: #999; text-align: center;\">© 2024 Love and Joy Blog. All rights reserved.</p>\n        </div>\n      `\n    };\n\n    // 发送邮件\n    const info = await transporter.sendMail(mailOptions);\n\n    return { success: true, message: '邮件发送成功' };\n  } catch (error) {\n    console.error('邮件发送失败:', error);\n    \n    // 提供更详细的错误信息\n    let errorMessage = '邮件发送失败，请稍后重试';\n    if (error instanceof Error) {\n      if (error.message.includes('authentication failed')) {\n        errorMessage = '邮件发送失败：认证失败，请检查邮箱和授权码是否正确';\n      } else if (error.message.includes('Invalid login')) {\n        errorMessage = '邮件发送失败：登录失败，请检查邮箱和授权码是否正确';\n      } else {\n        errorMessage = `邮件发送失败：${error.message}`;\n      }\n    }\n    \n    return { \n      success: false, \n      message: errorMessage\n    };\n  }\n};\n\n// 验证邮箱格式是否支持\nexport const isSupportedEmail = (email: string): boolean => {\n  const supportedDomains = ['qq.com', '163.com', '126.com', 'yeah.net', 'gmail.com', 'outlook.com', 'hotmail.com', 'sina.com', 'sina.cn', '139.com', '189.cn'];\n  const emailDomain = email.split('@')[1]?.toLowerCase();\n  return supportedDomains.includes(emailDomain || '');\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 282, "column": 0}, "map": {"version":3,"sources":["file:///D:/MyBlog/LoveandJoy/src/app/api/auth/send-verification-code/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { sendVerificationEmail } from '@/utils/emailService';\n\n// 内存存储验证码，生产环境建议使用Redis\nconst verificationCodes = new Map<string, { code: string; expiresAt: number; attempts: number }>();\n\n// 发送验证码\nexport async function POST(request: Request) {\n  try {\n    const { email } = await request.json();\n\n    // 验证邮箱格式\n    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\n    if (!email || !emailRegex.test(email)) {\n      return NextResponse.json(\n        { success: false, message: '请输入有效的邮箱地址' },\n        { status: 400 }\n      );\n    }\n\n    // 检查发送频率\n    const existingCode = verificationCodes.get(email);\n    const now = Date.now();\n    const cooldownPeriod = 60 * 1000; // 60秒冷却期\n    const maxAttempts = 5; // 每小时最大尝试次数\n    const attemptsResetPeriod = 60 * 60 * 1000; // 1小时重置尝试次数\n\n    if (existingCode) {\n      // 检查冷却期\n      if (now - (existingCode.expiresAt - 30 * 60 * 1000) < cooldownPeriod) {\n        return NextResponse.json(\n          { success: false, message: '发送过于频繁，请稍后再试' },\n          { status: 429 }\n        );\n      }\n\n      // 检查尝试次数\n      if (existingCode.attempts >= maxAttempts && now - (existingCode.expiresAt - 30 * 60 * 1000) < attemptsResetPeriod) {\n        return NextResponse.json(\n          { success: false, message: '验证码发送次数过多，请1小时后再试' },\n          { status: 429 }\n        );\n      }\n    }\n\n    // 生成6位验证码\n    const code = Math.floor(100000 + Math.random() * 900000).toString();\n    const expiresAt = now + 30 * 60 * 1000; // 30分钟后过期\n\n    // 发送邮件\n    const emailResult = await sendVerificationEmail(email, code);\n    \n    if (!emailResult.success) {\n      return NextResponse.json(\n        { success: false, message: emailResult.message },\n        { status: 500 }\n      );\n    }\n\n    // 存储验证码信息\n    verificationCodes.set(email, {\n      code,\n      expiresAt,\n      attempts: existingCode ? existingCode.attempts + 1 : 1\n    });\n\n    // 30分钟后自动删除过期验证码\n    setTimeout(() => {\n      verificationCodes.delete(email);\n    }, 30 * 60 * 1000);\n\n    return NextResponse.json({\n      success: true,\n      message: '验证码已发送到您的邮箱，请查收',\n      cooldown: cooldownPeriod\n    });\n  } catch (error) {\n    console.error('发送验证码失败:', error);\n    return NextResponse.json(\n      { success: false, message: '发送验证码失败，请稍后重试' },\n      { status: 500 }\n    );\n  }\n}\n\n// 验证验证码\nexport async function GET(request: Request) {\n  try {\n    const url = new URL(request.url);\n    const email = url.searchParams.get('email');\n    const code = url.searchParams.get('code');\n\n    if (!email || !code) {\n      return NextResponse.json(\n        { success: false, message: '缺少必要参数' },\n        { status: 400 }\n      );\n    }\n\n    const existingCode = verificationCodes.get(email);\n    const now = Date.now();\n\n    if (!existingCode) {\n      return NextResponse.json(\n        { success: false, message: '验证码不存在或已过期' },\n        { status: 400 }\n      );\n    }\n\n    if (now > existingCode.expiresAt) {\n      verificationCodes.delete(email);\n      return NextResponse.json(\n        { success: false, message: '验证码已过期，请重新获取' },\n        { status: 400 }\n      );\n    }\n\n    if (existingCode.code !== code) {\n      return NextResponse.json(\n        { success: false, message: '验证码错误' },\n        { status: 400 }\n      );\n    }\n\n    // 验证码验证成功，移除验证码\n    verificationCodes.delete(email);\n\n    return NextResponse.json({\n      success: true,\n      message: '验证码验证成功'\n    });\n  } catch (error) {\n    console.error('验证验证码失败:', error);\n    return NextResponse.json(\n      { success: false, message: '验证验证码失败，请稍后重试' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,wBAAwB;AACxB,MAAM,oBAAoB,IAAI;AAGvB,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEpC,SAAS;QACT,MAAM,aAAa;QACnB,IAAI,CAAC,SAAS,CAAC,WAAW,IAAI,CAAC,QAAQ;YACrC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAa,GACxC;gBAAE,QAAQ;YAAI;QAElB;QAEA,SAAS;QACT,MAAM,eAAe,kBAAkB,GAAG,CAAC;QAC3C,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,iBAAiB,KAAK,MAAM,SAAS;QAC3C,MAAM,cAAc,GAAG,YAAY;QACnC,MAAM,sBAAsB,KAAK,KAAK,MAAM,YAAY;QAExD,IAAI,cAAc;YAChB,QAAQ;YACR,IAAI,MAAM,CAAC,aAAa,SAAS,GAAG,KAAK,KAAK,IAAI,IAAI,gBAAgB;gBACpE,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,SAAS;oBAAO,SAAS;gBAAe,GAC1C;oBAAE,QAAQ;gBAAI;YAElB;YAEA,SAAS;YACT,IAAI,aAAa,QAAQ,IAAI,eAAe,MAAM,CAAC,aAAa,SAAS,GAAG,KAAK,KAAK,IAAI,IAAI,qBAAqB;gBACjH,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,SAAS;oBAAO,SAAS;gBAAoB,GAC/C;oBAAE,QAAQ;gBAAI;YAElB;QACF;QAEA,UAAU;QACV,MAAM,OAAO,KAAK,KAAK,CAAC,SAAS,KAAK,MAAM,KAAK,QAAQ,QAAQ;QACjE,MAAM,YAAY,MAAM,KAAK,KAAK,MAAM,UAAU;QAElD,OAAO;QACP,MAAM,cAAc,MAAM,IAAA,uJAAqB,EAAC,OAAO;QAEvD,IAAI,CAAC,YAAY,OAAO,EAAE;YACxB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS,YAAY,OAAO;YAAC,GAC/C;gBAAE,QAAQ;YAAI;QAElB;QAEA,UAAU;QACV,kBAAkB,GAAG,CAAC,OAAO;YAC3B;YACA;YACA,UAAU,eAAe,aAAa,QAAQ,GAAG,IAAI;QACvD;QAEA,iBAAiB;QACjB,WAAW;YACT,kBAAkB,MAAM,CAAC;QAC3B,GAAG,KAAK,KAAK;QAEb,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;YACT,UAAU;QACZ;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,YAAY;QAC1B,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,SAAS;QAAgB,GAC3C;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,MAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;QAC/B,MAAM,QAAQ,IAAI,YAAY,CAAC,GAAG,CAAC;QACnC,MAAM,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC;QAElC,IAAI,CAAC,SAAS,CAAC,MAAM;YACnB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAS,GACpC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,eAAe,kBAAkB,GAAG,CAAC;QAC3C,MAAM,MAAM,KAAK,GAAG;QAEpB,IAAI,CAAC,cAAc;YACjB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAa,GACxC;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,MAAM,aAAa,SAAS,EAAE;YAChC,kBAAkB,MAAM,CAAC;YACzB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAe,GAC1C;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,aAAa,IAAI,KAAK,MAAM;YAC9B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAQ,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,gBAAgB;QAChB,kBAAkB,MAAM,CAAC;QAEzB,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;QACX;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,YAAY;QAC1B,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,SAAS;QAAgB,GAC3C;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}