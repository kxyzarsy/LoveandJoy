{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/MyBlog/LoveandJoy/src/app/api/admin/credentials/access-password/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\n// 模拟日志记录函数\r\nconst logOperation = (action: string, userId: string | null, ipAddress: string, success: boolean, details?: string) => {\r\n  console.log(`[${new Date().toISOString()}] ${action} - User: ${userId}, IP: ${ipAddress}, Success: ${success}, Details: ${details}`);\r\n};\r\n\r\n// 模拟获取当前初始访问密码\r\nconst getCurrentAccessPassword = async (): Promise<string> => {\r\n  // 这里使用环境变量作为临时解决方案，后续将替换为数据库查询\r\n  return process.env.INITIAL_ACCESS_PASSWORD || 'default-access-password';\r\n};\r\n\r\n// 模拟验证初始访问密码\r\nconst validateAccessPassword = async (password: string): Promise<boolean> => {\r\n  const currentPassword = await getCurrentAccessPassword();\r\n  return password === currentPassword;\r\n};\r\n\r\nexport async function PUT(request: Request) {\r\n  try {\r\n    const body = await request.json();\r\n    const { currentPassword, newPassword } = body;\r\n    \r\n    // 获取客户端IP地址\r\n    const ipAddress = request.headers.get('x-forwarded-for') || request.headers.get('remote-addr') || 'unknown';\r\n    \r\n    // 验证当前密码\r\n    const isValid = await validateAccessPassword(currentPassword);\r\n    if (!isValid) {\r\n      logOperation('Update Initial Access Password', null, ipAddress, false, 'Invalid current access password');\r\n      return NextResponse.json({ error: '当前密码验证失败' }, { status: 401 });\r\n    }\r\n    \r\n    // 验证新密码复杂度\r\n    if (newPassword.length < 8) {\r\n      logOperation('Update Initial Access Password', null, ipAddress, false, 'New password too short');\r\n      return NextResponse.json({ error: '密码长度至少为8个字符' }, { status: 400 });\r\n    }\r\n    \r\n    if (!/[A-Z]/.test(newPassword)) {\r\n      logOperation('Update Initial Access Password', null, ipAddress, false, 'New password missing uppercase letter');\r\n      return NextResponse.json({ error: '密码必须包含至少一个大写字母' }, { status: 400 });\r\n    }\r\n    \r\n    if (!/[a-z]/.test(newPassword)) {\r\n      logOperation('Update Initial Access Password', null, ipAddress, false, 'New password missing lowercase letter');\r\n      return NextResponse.json({ error: '密码必须包含至少一个小写字母' }, { status: 400 });\r\n    }\r\n    \r\n    if (!/[0-9]/.test(newPassword)) {\r\n      logOperation('Update Initial Access Password', null, ipAddress, false, 'New password missing number');\r\n      return NextResponse.json({ error: '密码必须包含至少一个数字' }, { status: 400 });\r\n    }\r\n    \r\n    // 这里应该是更新数据库中的初始访问密码，目前使用环境变量模拟\r\n    console.log('初始访问密码已更新:', newPassword);\r\n    \r\n    // 记录操作日志\r\n    logOperation('Update Initial Access Password', null, ipAddress, true, 'Access password updated successfully');\r\n    \r\n    // 发送密码更新通知邮件\r\n    try {\r\n      await fetch('/api/send-email', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          to: 'kxyatxy116@163.com',\r\n          subject: '【重要】初始访问密码已更新',\r\n          html: `\r\n            <h2>初始访问密码更新通知</h2>\r\n            <p>管理员登录入口的初始访问密码已成功更新，新密码如下：</p>\r\n            <p style=\"font-size: 18px; font-weight: bold; color: #333; background: #f0f0f0; padding: 10px; border-radius: 5px;\">${newPassword}</p>\r\n            <p>请妥善保管此密码，切勿泄露给他人。</p>\r\n            <hr>\r\n            <p>此邮件由系统自动发送，请勿回复。</p>\r\n          `\r\n        })\r\n      });\r\n    } catch (emailError) {\r\n      console.error('发送初始访问密码更新邮件失败:', emailError);\r\n    }\r\n    \r\n    return NextResponse.json({ success: true, message: '初始访问密码更新成功' });\r\n  } catch (error) {\r\n    console.error('更新初始访问密码失败:', error);\r\n    return NextResponse.json({ error: '更新失败，请稍后重试' }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;;AAEA,WAAW;AACX,MAAM,eAAe,CAAC,QAAgB,QAAuB,WAAmB,SAAkB;IAChG,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,IAAI,OAAO,WAAW,GAAG,EAAE,EAAE,OAAO,SAAS,EAAE,OAAO,MAAM,EAAE,UAAU,WAAW,EAAE,QAAQ,WAAW,EAAE,SAAS;AACrI;AAEA,eAAe;AACf,MAAM,2BAA2B;IAC/B,+BAA+B;IAC/B,OAAO,QAAQ,GAAG,CAAC,uBAAuB,IAAI;AAChD;AAEA,aAAa;AACb,MAAM,yBAAyB,OAAO;IACpC,MAAM,kBAAkB,MAAM;IAC9B,OAAO,aAAa;AACtB;AAEO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,eAAe,EAAE,WAAW,EAAE,GAAG;QAEzC,YAAY;QACZ,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB,QAAQ,OAAO,CAAC,GAAG,CAAC,kBAAkB;QAElG,SAAS;QACT,MAAM,UAAU,MAAM,uBAAuB;QAC7C,IAAI,CAAC,SAAS;YACZ,aAAa,kCAAkC,MAAM,WAAW,OAAO;YACvE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAW,GAAG;gBAAE,QAAQ;YAAI;QAChE;QAEA,WAAW;QACX,IAAI,YAAY,MAAM,GAAG,GAAG;YAC1B,aAAa,kCAAkC,MAAM,WAAW,OAAO;YACvE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAc,GAAG;gBAAE,QAAQ;YAAI;QACnE;QAEA,IAAI,CAAC,QAAQ,IAAI,CAAC,cAAc;YAC9B,aAAa,kCAAkC,MAAM,WAAW,OAAO;YACvE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,IAAI,CAAC,QAAQ,IAAI,CAAC,cAAc;YAC9B,aAAa,kCAAkC,MAAM,WAAW,OAAO;YACvE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,IAAI,CAAC,QAAQ,IAAI,CAAC,cAAc;YAC9B,aAAa,kCAAkC,MAAM,WAAW,OAAO;YACvE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,gCAAgC;QAChC,QAAQ,GAAG,CAAC,cAAc;QAE1B,SAAS;QACT,aAAa,kCAAkC,MAAM,WAAW,MAAM;QAEtE,aAAa;QACb,IAAI;YACF,MAAM,MAAM,mBAAmB;gBAC7B,QAAQ;gBACR,SAAS;oBACP,gBAAgB;gBAClB;gBACA,MAAM,KAAK,SAAS,CAAC;oBACnB,IAAI;oBACJ,SAAS;oBACT,MAAM,CAAC;;;gIAG+G,EAAE,YAAY;;;;UAIpI,CAAC;gBACH;YACF;QACF,EAAE,OAAO,YAAY;YACnB,QAAQ,KAAK,CAAC,mBAAmB;QACnC;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,SAAS;QAAa;IAClE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,eAAe;QAC7B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAa,GAAG;YAAE,QAAQ;QAAI;IAClE;AACF"}}]
}