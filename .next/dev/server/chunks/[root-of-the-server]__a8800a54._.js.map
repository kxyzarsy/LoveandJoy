{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///D:/MyBlog/LoveandJoy/src/app/api/auth/login/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport mysql from 'mysql2/promise';\r\nimport jwt from 'jsonwebtoken';\r\n\r\n// 创建数据库连接\r\nasync function createConnection() {\r\n  return mysql.createConnection({\r\n    host: 'localhost',\r\n    port: 3306,\r\n    user: 'root',\r\n    password: '123456',\r\n    database: 'yueblog'\r\n  });\r\n}\r\n\r\n// 生成JWT令牌\r\nfunction generateToken(userId: number, email: string, role: string) {\r\n  // 使用环境变量或安全的密钥\r\n  const secretKey = process.env.JWT_SECRET || 'your-secret-key';\r\n  const expiresIn = '2h'; // 令牌过期时间\r\n  \r\n  return jwt.sign(\r\n    { userId, email, role },\r\n    secretKey,\r\n    { expiresIn }\r\n  );\r\n}\r\n\r\n// 登录接口\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const body = await request.json();\r\n    const { email, password } = body;\r\n    \r\n    // 验证请求参数\r\n    if (!email || !password) {\r\n      return NextResponse.json(\r\n        { success: false, message: '邮箱和密码不能为空' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    \r\n    // 连接数据库\r\n    const connection = await createConnection();\r\n    \r\n    // 查询用户\r\n    const [rows] = await connection.execute(\r\n      'SELECT id, name, email, password, usernameId, avatar, role FROM user WHERE email = ?',\r\n      [email]\r\n    );\r\n    \r\n    // 检查用户是否存在\r\n    const users = rows as any[];\r\n    if (users.length === 0) {\r\n      await connection.end();\r\n      return NextResponse.json(\r\n        { success: false, message: '账号不存在' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n    \r\n    const user = users[0];\r\n    \r\n    // 验证密码（注意：这里应该使用bcrypt等加密算法，当前为了测试方便直接比对）\r\n    if (user.password !== password) {\r\n      await connection.end();\r\n      return NextResponse.json(\r\n        { success: false, message: '密码错误' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n    \r\n    // 更新用户的最后登录时间\r\n    await connection.execute(\r\n      'UPDATE user SET lastLoginAt = NOW() WHERE id = ?',\r\n      [user.id]\r\n    );\r\n    \r\n    await connection.end();\r\n    \r\n    // 生成JWT令牌\r\n    const token = generateToken(user.id, user.email, user.role);\r\n    \r\n    // 构建响应数据\r\n    const userInfo = {\r\n      id: user.id,\r\n      name: user.name,\r\n      email: user.email,\r\n      usernameId: user.usernameId,\r\n      avatar: user.avatar,\r\n      role: user.role\r\n    };\r\n    \r\n    // 返回成功响应\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: {\r\n        token,\r\n        userInfo\r\n      },\r\n      message: '登录成功'\r\n    }, { status: 200 });\r\n    \r\n  } catch (error) {\r\n    console.error('登录失败:', error);\r\n    return NextResponse.json(\r\n      { success: false, message: '登录失败，请稍后重试' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,UAAU;AACV,eAAe;IACb,OAAO,8IAAK,CAAC,gBAAgB,CAAC;QAC5B,MAAM;QACN,MAAM;QACN,MAAM;QACN,UAAU;QACV,UAAU;IACZ;AACF;AAEA,UAAU;AACV,SAAS,cAAc,MAAc,EAAE,KAAa,EAAE,IAAY;IAChE,eAAe;IACf,MAAM,YAAY,QAAQ,GAAG,CAAC,UAAU,IAAI;IAC5C,MAAM,YAAY,MAAM,SAAS;IAEjC,OAAO,kJAAG,CAAC,IAAI,CACb;QAAE;QAAQ;QAAO;IAAK,GACtB,WACA;QAAE;IAAU;AAEhB;AAGO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG;QAE5B,SAAS;QACT,IAAI,CAAC,SAAS,CAAC,UAAU;YACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAY,GACvC;gBAAE,QAAQ;YAAI;QAElB;QAEA,QAAQ;QACR,MAAM,aAAa,MAAM;QAEzB,OAAO;QACP,MAAM,CAAC,KAAK,GAAG,MAAM,WAAW,OAAO,CACrC,wFACA;YAAC;SAAM;QAGT,WAAW;QACX,MAAM,QAAQ;QACd,IAAI,MAAM,MAAM,KAAK,GAAG;YACtB,MAAM,WAAW,GAAG;YACpB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAQ,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,KAAK,CAAC,EAAE;QAErB,0CAA0C;QAC1C,IAAI,KAAK,QAAQ,KAAK,UAAU;YAC9B,MAAM,WAAW,GAAG;YACpB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAO,GAClC;gBAAE,QAAQ;YAAI;QAElB;QAEA,cAAc;QACd,MAAM,WAAW,OAAO,CACtB,oDACA;YAAC,KAAK,EAAE;SAAC;QAGX,MAAM,WAAW,GAAG;QAEpB,UAAU;QACV,MAAM,QAAQ,cAAc,KAAK,EAAE,EAAE,KAAK,KAAK,EAAE,KAAK,IAAI;QAE1D,SAAS;QACT,MAAM,WAAW;YACf,IAAI,KAAK,EAAE;YACX,MAAM,KAAK,IAAI;YACf,OAAO,KAAK,KAAK;YACjB,YAAY,KAAK,UAAU;YAC3B,QAAQ,KAAK,MAAM;YACnB,MAAM,KAAK,IAAI;QACjB;QAEA,SAAS;QACT,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ;gBACA;YACF;YACA,SAAS;QACX,GAAG;YAAE,QAAQ;QAAI;IAEnB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,SAAS;QACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,SAAS;QAAa,GACxC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}