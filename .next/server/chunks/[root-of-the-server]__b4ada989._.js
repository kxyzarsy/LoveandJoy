module.exports=[93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},27699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},4446,(e,t,r)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,r)=>{t.exports=e.x("tls",()=>require("tls"))},88947,(e,t,r)=>{t.exports=e.x("stream",()=>require("stream"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},6461,(e,t,r)=>{t.exports=e.x("zlib",()=>require("zlib"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},75343,(e,t,r)=>{t.exports=e.x("bcrypt",()=>require("bcrypt"))},36170,e=>{"use strict";let t={logLevel:"INFO",maxFileSize:0xa00000,backupCount:5,logDirectory:"logs",enableConsoleLogging:!0,enableFileLogging:!0},r=e=>{let t=`${e.timestamp} [${e.level}] [${e.type}] [${e.action}] [${e.status}]`,r=e.userId?` [User: ${e.userId} (${e.username||"N/A"})]`:"",a=e.requestId?` [Request: ${e.requestId}]`:"",s=e.resource?` [Resource: ${e.resource}]`:"",n=` [IP: ${e.ipAddress}]`,o=e.details?` Details: ${JSON.stringify(e.details)}`:"";return`${t}${r}${a}${s}${n} - ${e.message}${o}`},a=new class{config;logQueue=[];flushInterval=null;constructor(e){this.config={...t,...e},this.initLogDirectory(),this.flushInterval=setInterval(()=>{this.flushLogQueue()},5e3)}initLogDirectory(){if(this.config.enableFileLogging)try{{let t=e.r(22734),r=e.r(14747).join(process.cwd(),this.config.logDirectory);t.existsSync(r)||t.mkdirSync(r,{recursive:!0})}}catch(e){console.error("Failed to initialize log directory:",e)}}log(e,t,r,a){var s;let n;if(s=this.config.logLevel,!((n=["DEBUG","INFO","WARN","ERROR","CRITICAL","SECURITY"]).indexOf(e)>=n.indexOf(s)))return;let o={id:Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),timestamp:new Date().toISOString(),level:e,type:t,message:r,...a};this.logQueue.push(o),this.config.enableConsoleLogging&&this.logToConsole(o),["ERROR","CRITICAL","SECURITY"].includes(e)&&this.flushLogQueue()}logToConsole(e){let t=r(e);switch(e.level){case"DEBUG":console.debug(t);break;case"INFO":console.info(t);break;case"WARN":console.warn(t);break;case"ERROR":case"SECURITY":console.error(t);break;case"CRITICAL":console.error("\x1b[31m"+t+"\x1b[0m");break;default:console.log(t)}}async logToFile(t){if(this.config.enableFileLogging)try{{let a=e.r(22734),s=e.r(14747),n=new Date().toISOString().split("T")[0],o=`${n}-${t.type.toLowerCase()}.log`,i=s.join(process.cwd(),this.config.logDirectory,o),l=r(t)+"\n";a.appendFileSync(i,l,"utf8"),this.checkAndRotateLogs(i)}}catch(e){console.error("Failed to write log to file:",e)}}checkAndRotateLogs(t){try{{let r=e.r(22734),a=e.r(14747);if(r.statSync(t).size>this.config.maxFileSize){let e=`${t}.${Date.now()}`;r.renameSync(t,e),r.writeFileSync(t,"","utf8"),this.cleanupOldBackups(a.dirname(t),a.basename(t))}}}catch(e){console.error("Failed to rotate logs:",e)}}cleanupOldBackups(t,r){try{{let a=e.r(22734),s=e.r(14747),n=a.readdirSync(t).filter(e=>e.startsWith(r)&&e!==r).map(e=>s.join(t,e)).sort((e,t)=>a.statSync(e).mtime.getTime()-a.statSync(t).mtime.getTime());for(;n.length>this.config.backupCount;){let e=n.shift();e&&a.unlinkSync(e)}}}catch(e){console.error("Failed to cleanup old backups:",e)}}flushLogQueue(){if(0===this.logQueue.length)return;let e=[...this.logQueue];this.logQueue=[],e.forEach(e=>{this.logToFile(e).catch(e=>{console.error("Failed to write log:",e)})})}logAuthentication(e,t){this.log("FAILURE"===t.status?"SECURITY":"INFO","AUTHENTICATION",e,t)}logAuthorization(e,t){this.log("FAILURE"===t.status?"SECURITY":"INFO","AUTHORIZATION",e,t)}logApiCall(e,t){this.log("FAILURE"===t.status?"ERROR":"INFO","API_CALL",e,t)}logSecurityViolation(e,t){this.log("SECURITY","SECURITY_VIOLATION",e,{...t,status:"FAILURE"})}close(){this.flushInterval&&(clearInterval(this.flushInterval),this.flushInterval=null),this.flushLogQueue()}};e.s(["securityLogger",0,a])},10655,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),s=e.i(59756),n=e.i(61916),o=e.i(14444),i=e.i(37092),l=e.i(69741),u=e.i(16795),c=e.i(87718),d=e.i(95169),p=e.i(47587),h=e.i(66012),g=e.i(70101),R=e.i(74838),x=e.i(10372),m=e.i(93695);e.i(52474);var f=e.i(220),E=e.i(89171),w=e.i(22244),v=e.i(75343),C=e.i(36170);async function I(){return w.default.createConnection({host:"localhost",port:3306,user:"root",password:"123456",database:"yueblog"})}async function y(e,{params:t}){try{let r=await t,a=parseInt(r.id),s=new URL(e.url).pathname,n=await I();if(s.endsWith("/posts/count")){let[e]=await n.execute("SELECT COUNT(*) as count FROM post WHERE authorId = ?",[a]);await n.end();let t=e[0].count;return E.NextResponse.json({count:t},{status:200})}let[o]=await n.execute("SELECT id, name, email, usernameId, avatar, backgroundImage, bio, createdAt, updatedAt, lastUsernameChange FROM user WHERE id = ?",[a]);await n.end();let i=o[0];if(!i)return E.NextResponse.json({error:"用户不存在"},{status:404});let l=0;if(i.lastUsernameChange){let e=new Date(i.lastUsernameChange),t=(new Date().getTime()-e.getTime())/36e5;l=Math.max(0,Math.ceil(720-t))}return E.NextResponse.json({...i,remainingUsernameChangeHours:l},{status:200})}catch(e){return console.error("获取用户数据失败:",e),E.NextResponse.json({error:"获取用户数据失败"},{status:500})}}async function T(e,{params:t}){try{let r=await t,a=parseInt(r.id),{name:s,email:n,password:o,avatar:i,bio:l,role:u,lastLoginAt:c,usernameId:d,backgroundImage:p}=await e.json(),h=await I();await h.beginTransaction();let g=[],R=[];if(void 0!==s&&(g.push("name = ?"),R.push(s||null)),void 0!==n&&(g.push("email = ?"),R.push(n||null)),void 0!==o&&o){let e=await v.default.hash(o,10);g.push("password = ?"),R.push(e)}if(void 0!==d&&(g.push("usernameId = ?"),R.push(d||null),g.push("lastUsernameChange = NOW()")),void 0!==i){let e=i||null;e&&"string"==typeof e&&(e.startsWith("data:")&&e.length>1048576?e="https://via.placeholder.com/100":e.length>1e5&&(e=e.substring(0,1e5))),g.push("avatar = ?"),R.push(e)}if(void 0!==p){let e=p||null;e&&"string"==typeof e&&(e.startsWith("data:")&&e.length>1048576?e=null:e.length>1e5&&(e=e.substring(0,1e5))),g.push("backgroundImage = ?"),R.push(e)}if(void 0!==l&&(g.push("bio = ?"),R.push(l||null)),void 0!==u&&(g.push("role = ?"),R.push(u||null)),g.push("updatedAt = NOW()"),R.push(a),g.length>1){if(void 0!==d){let[e]=await h.execute("SELECT id FROM user WHERE usernameId = ? AND id != ?",[d,a]);if(e.length>0)return await h.rollback(),await h.end(),E.NextResponse.json({error:"用户名ID已存在",message:"该用户名ID已被其他用户使用，请选择其他ID"},{status:400})}let[e]=await h.execute(`UPDATE user SET ${g.join(", ")} WHERE id = ?`,R);if(0===e.affectedRows)return await h.rollback(),await h.end(),E.NextResponse.json({error:"用户不存在"},{status:404})}let[x]=await h.execute("SELECT id, name, email, usernameId, avatar, backgroundImage, bio, createdAt, updatedAt, lastUsernameChange FROM user WHERE id = ?",[a]),m=x[0];if(void 0!==o&&o){let t=e.headers.get("x-forwarded-for")||"unknown";C.securityLogger.logApiCall("用户密码修改",{ipAddress:t,action:"UPDATE_PASSWORD",resource:`/api/users/${a}`,status:"SUCCESS",details:{userId:a,username:s||m?.name}})}await h.commit(),await h.end();let f=0;if(m.lastUsernameChange){let e=new Date(m.lastUsernameChange),t=(new Date().getTime()-e.getTime())/36e5;f=Math.max(0,Math.ceil(720-t))}return E.NextResponse.json({...m,remainingUsernameChangeHours:f},{status:200})}catch(e){return console.error("更新用户数据失败:",e),E.NextResponse.json({error:"更新用户数据失败",details:e.message},{status:500})}}async function b(e,{params:t}){try{let r=await t,a=parseInt(r.id),s=(await e.json().catch(()=>({}))).deletePosts||!1,n=await I();await n.beginTransaction();try{let[e]=await n.execute("SELECT id, name, email, usernameId, avatar, bio, createdAt, updatedAt FROM user WHERE id = ?",[a]),t=e[0];if(!t)return await n.rollback(),await n.end(),E.NextResponse.json({error:"用户不存在"},{status:404});if(s)await n.execute("DELETE FROM post WHERE authorId = ?",[a]);else{let[e]=await n.execute("SELECT COUNT(*) as postCount FROM post WHERE authorId = ?",[a]),t=e[0].postCount;if(t>0)return await n.rollback(),await n.end(),E.NextResponse.json({error:"删除用户失败",message:`该用户还有${t}个关联的帖子，无法直接删除。请先删除这些帖子，或联系管理员处理。`},{status:400})}return await n.execute("DELETE FROM user WHERE id = ?",[a]),await n.commit(),await n.end(),E.NextResponse.json(t,{status:200})}catch(e){if(await n.rollback(),await n.end(),"ER_ROW_IS_REFERENCED_2"===e.code)return E.NextResponse.json({error:"删除用户失败",message:"该用户还有关联的数据（如帖子），无法直接删除。请先删除这些关联数据，或联系管理员处理。"},{status:400});throw e}}catch(e){return console.error("删除用户失败:",e),E.NextResponse.json({error:"删除用户失败"},{status:500})}}e.s(["DELETE",()=>b,"GET",()=>y,"PUT",()=>T],97613);var A=e.i(97613);let S=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/users/[id]/route",pathname:"/api/users/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/users/[id]/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:O,workUnitAsyncStorage:N,serverHooks:U}=S;function k(){return(0,a.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:N})}async function L(e,t,a){S.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/users/[id]/route";E=E.replace(/\/index$/,"")||"/";let w=await S.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:C,nextConfig:I,parsedUrl:y,isDraftMode:T,prerenderManifest:b,routerServerContext:A,isOnDemandRevalidate:O,revalidateOnlyGenerated:N,resolvedPathname:U,clientReferenceManifest:k,serverActionsManifest:L}=w,F=(0,l.normalizeAppPath)(E),D=!!(b.dynamicRoutes[F]||b.routes[U]),j=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,y,!1):t.end("This page could not be found"),null);if(D&&!T){let e=!!b.routes[U],t=b.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await j();throw new m.NoFallbackError}}let q=null;!D||S.isDev||T||(q="/index"===(q=U)?"/":q);let $=!0===S.isDev||!D,H=D&&!$;L&&k&&(0,o.setReferenceManifestsSingleton)({page:E,clientReferenceManifest:k,serverActionsManifest:L,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:L})});let M=e.method||"GET",P=(0,n.getTracer)(),_=P.getActiveScopeSpan(),W={params:C,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>S.onRequestError(e,t,a,A)},sharedContext:{buildId:v}},B=new u.NodeNextRequest(e),Q=new u.NodeNextResponse(t),z=c.NextRequestAdapter.fromNodeNextRequest(B,(0,c.signalFromNodeResponse)(t));try{let o=async e=>S.handle(z,W).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=P.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${M} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${E}`)}),i=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var n,l;let u=async({previousCacheEntry:r})=>{try{if(!i&&O&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(s);e.fetchMetrics=W.renderOpts.fetchMetrics;let l=W.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=W.renderOpts.collectedTags;if(!D)return await (0,h.sendResponse)(B,Q,n,W.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[x.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==W.renderOpts.collectedRevalidate&&!(W.renderOpts.collectedRevalidate>=x.INFINITE_CACHE)&&W.renderOpts.collectedRevalidate,a=void 0===W.renderOpts.collectedExpire||W.renderOpts.collectedExpire>=x.INFINITE_CACHE?void 0:W.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:O})},A),t}},c=await S.handleResponse({req:e,nextConfig:I,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:i});if(!D)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",O?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&D||d.delete(x.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,R.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)(B,Q,new Response(c.value.body,{headers:d,status:c.value.status||200})),null};_?await l(_):await P.withPropagatedContext(e.headers,()=>P.trace(d.BaseServerSpan.handleRequest,{spanName:`${M} ${E}`,kind:n.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:O})}),D)throw t;return await (0,h.sendResponse)(B,Q,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>k,"routeModule",()=>S,"serverHooks",()=>U,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>N],10655)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__b4ada989._.js.map